// Prisma schema file
// learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  BLOCKED
  UNDER_REVIEW
}

enum RiskCategory {
  HIGH
  MEDIUM
  LOW
}

model Transaction {
  id        String   @id @default(uuid())
  timestamp DateTime

  senderAccount   BigInt
  receiverAccount BigInt
  amountNgn       Float

  transactionType  String
  merchantCategory String
  location         String
  deviceUsed       String
  paymentChannel   String
  fraudType        String?
  ipGeoRegion      String

  txnHour      Int
  isWeekend    Boolean
  isSalaryWeek Boolean
  isNightTxn   Boolean

  timeSinceLastTransaction  Float?
  spendingDeviationScore    Float
  velocityScore             Int
  geoAnomalyScore           Float
  bvnLinked                 Boolean
  newDeviceTransaction      Boolean
  senderPersona             String
  geospatialVelocityAnomaly Boolean

  deviceSeenCount Int
  isDeviceShared  Boolean
  ipSeenCount     Int
  isIpShared      Boolean

  userTxnCountTotal   Int
  userAvgTxnAmt       Float
  userStdTxnAmt       Float
  userTxnFrequency24h Int
  userTopCategory     String

  txnCountLast1h    Int
  txnCountLast24h   Int
  totalAmountLast1h Float
  timeSinceLast     Float?
  avgGapBetweenTxns Float?

  merchantFraudRate Float
  channelRiskScore  Float
  personaFraudRisk  Float
  locationFraudRisk Float

  isFraud Boolean
  status  TransactionStatus @default(PENDING)

  createdAt DateTime @default(now())

  reviews TransactionReview[]
  actions ActionLog[]
}

model TransactionReview {
  id            String @id @default(uuid())
  transactionId String @unique

  reviewedBy     String
  riskCategory   RiskCategory
  flaggedReasons Json

  reviewedAt DateTime @default(now())

  transaction Transaction @relation(fields: [transactionId], references: [id])
}

model ActionLog {
  id            String @id @default(uuid())
  transactionId String

  actionTaken String
  performedBy String
  notes       String?

  timestamp DateTime @default(now())

  transaction Transaction @relation(fields: [transactionId], references: [id])
}

model DatasetRun {
  id               String    @id @default(uuid())
  datasetName      String
  status           String
  recordsProcessed Int       @default(0)
  startedAt        DateTime  @default(now())
  endedAt          DateTime?
}
